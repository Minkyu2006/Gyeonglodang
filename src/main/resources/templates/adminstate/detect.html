<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate ="~{layout/admindefault}">

<head>
    <script type="text/javascript">

        $(function() {
            dataInfo();
            realTime();
            AutoStart();
			detectGet();
			setInterval(detectGet, 60000); // 1분마다 데이터 불러와 실행
			
			var sensorInput = '<li><input type="text" class="sensor__input" /><button class="sensor__delete">삭제</button></li>'
			$('.sensor__add').on('click', function() {
				var list = $(this).parent('.sensor__head').next().children();
				list.append(sensorInput);
			});
            $('.sensor__body ul').on('click', '.sensor__delete', function() {
				$(this).parent('li').remove();
			});

        })

        // 데이터 받아오는 함수
        function dataInfo() {
            $.ajax({
                url: '/adminhomedata/adminMenuDataInfo',
                type: 'post',
                cache: false,
                error: function () {
                    alert('데이터받기 실패');
                },
                success: function (res) {

                    // 에어컨셋팅
                    if(res.data.aircondition !== '') {
                        airconditionCheck(res.data.aircondition.r_data);
                    }

                    // 조명셋팅
                    if(res.data.lightData !== ''){
                        lightCheck(res.data.lightData.r_data)
                    }

                    // 공기청정기셋팅
                    if(res.data.airpurification !== '') {
                        airpurificationCheck(res.data.airpurification.r_data);
                    }

                    // 가전전원셋팅
                    if(res.data.electricDate !== ''){
                        electricCheck(res.data.electricDate.r_data);
                    }

                    if(res.data.batteryData !== '') {
                        // 배터리 셋팅
                        var battery = JSON.parse(res.data.batteryData.r_data);
                        console.log('');

                        var batteryLowValue = 100;
                        $.each(battery,function(key, value){
                            if(value!=="" && batteryLowValue>Number(value)){
                                batteryLowValue = Number(value);
                            }
                        });
                        console.log('제일 낮은 battery : ' + batteryLowValue);
                        batteryRefresh(batteryLowValue)
                    }
                }
            });
        }

		// todo 디텍트 데이터 보내기
        function detectPut() {

            var $smokeUl = $("#smokeUl");
            var $gasUl = $("#gasUl");
            var $motionUl = $("#motionUl");

            var smokedetector = [];
            var gasdetector = [];
            var motionsensorchecklist = [];

            var value;
            $smokeUl.children().each(function(){
                value = $(this).children('.sensor__input').val();
                console.log("value : "+value);
                if(value===""){

                }else if(value===undefined){

                }else{
                    smokedetector.push({"id":value});
                }
            });
            console.log("smokedetector : "+smokedetector);

            $gasUl.children().each(function(){
                value = $(this).children('.sensor__input').val();
                console.log("value : "+value);
                if(value===""){

                }else if(value===undefined){

                }else{
                    gasdetector.push({"id":value});
                }
            });
            console.log("gasdetector : "+gasdetector);

            $motionUl.children().each(function(){
                value = $(this).children('.sensor__input').val();
                console.log("value : "+value);
                if(value===""){

                }else if(value===undefined){

                }else{
                    motionsensorchecklist.push({"id":value});
                }
            });
            console.log("motionsensorchecklist : "+motionsensorchecklist);

			var settings = {
				"url": "http://square.abrain.co.kr:8080/square/operation/detector?system_id=S002",
				"method": "PUT",
				"timeout": 0,
				"headers": {
					"Content-Type": "application/json"
				},
				"data": JSON.stringify({"smokedetector":smokedetector,
										"gasdetector":gasdetector,
										"motionsensorchecklist":motionsensorchecklist}),
			};

			$.ajax(settings).done(function (response) {
                console.log("response : "+response);
				if(response==="400"){
                    alertSuccess("필수 입력 요소가 누락되었거나 값이 잘못되었습니다.");
                }
				alertSuccess("저장되었습니다.");
                detectGet();
			});

		}

		// todo 운영정책 데이터 가져오기.
		function detectGet() {

			var params = {
				value : "http://square.abrain.co.kr:8080/square/operation/detector?system_id=S002"
			};

			$.ajax({
				url: '/apiData/operationGet',
				type: 'post',
				data: params,
				cache: false,
				error: function () {
					alert('디텍트 데이터받기 실패');
				},
				success: function (res) {

					if (res.data.operationDate !== '') {
						console.log("디텍트 셋팅데이터 system_id=S002 : "+res.data.operationDate);
						console.log("");
						var operationDate = JSON.parse(res.data.operationDate);
						// console.log("operationDate : "+operationDate);

                        var smoke = [];
                        var gas = [];
                        var motion = [];

                        var $smokeUl = $("#smokeUl");
                        var $gasUl = $("#gasUl");
                        var $motionUl = $("#motionUl");

                        operationDate.data.smokedetector.forEach(function(item) {
                            smoke.push(item.id)
                        });
                        console.log("smoke : "+smoke);
                        $smokeUl.empty();
                        var htmlSmoke = '';
                        for(i=0; i<smoke.length; i++) {
                            htmlSmoke += '<li>'
                            htmlSmoke += '<input type="text" value="'+smoke[i]+'" class="sensor__input" />'
                            htmlSmoke += '<button class="sensor__delete">삭제</button>'
                            htmlSmoke += '</li>'
                        }
                        $smokeUl.append(htmlSmoke);


                        operationDate.data.gasdetector.forEach(function(item) {
                            gas.push(item.id)
                        });
                        console.log("gas : "+gas);
                        $gasUl.empty();
                        var htmlGas = '';
                        for(i=0; i<gas.length; i++) {
                            htmlGas += '<li>'
                            htmlGas += '<input type="text" value="'+gas[i]+'" class="sensor__input" />'
                            htmlGas += '<button class="sensor__delete">삭제</button>'
                            htmlGas += '</li>'
                        }
                        $gasUl.append(htmlGas);


                        operationDate.data.motionsensorchecklist.forEach(function(item) {
                            motion.push(item.id)
                        });
                        console.log("motion : "+motion);
                        $motionUl.empty();
                        var htmlMotion = '';
                        for(i=0; i<motion.length; i++) {
                            htmlMotion += '<li>'
                            htmlMotion += '<input type="text" value="'+motion[i]+'" class="sensor__input" />'
                            htmlMotion += '<button class="sensor__delete">삭제</button>'
                            htmlMotion += '</li>'
                        }
                        $motionUl.append(htmlMotion);


					}
				}
			});
		}

    </script>
</head>

<body>
<div class="wrap">
    <div class="console">
        <div class="infobox">
            <h2 class="info-title">Manager Mode
				<ul>
					<li><a href="/admindashboard/system" class="up-icon"><img src="/assets/images/btn_setting.png" alt=""/></a></li>
					<li><a id="passwordchange" href="#" class="up-icon"><img src="/assets/images/icon_password.png" alt=""/></a></li>
				</ul>
			</h2>
            <div class="datetime">
                <span class="date">2021.01.18 월요일</span>
                <span class="time">am 10:16</span>
            </div>
        </div>
        <div class="iot-buttons">
            <h3>IoT 가전제어</h3>
            <ul>
                <li>
                    <button id="airBtn" class="console-button aircon">에어컨<span>ON</span></button>
                </li>
                <li>
                    <button id="lightBtn" class="console-button light">조명<span>ON</span></button>
                </li>
                <li>
                    <button id="aqBtn" class="console-button airfresher">공기청정기<span>ON</span></button>
                </li>
                <li>
                    <button id="electricBtn" class="console-button electronic">가전 전원<span>ON</span></button>
                </li>
            </ul>
        </div>
        <div class="battery">
            <div class="battery__head">
                <h3 class="battery_title">배터리</h3>
                <span class="battery-percent"></span>
                <a href="/admindashboard/battery" class="battery-link"><img src="/assets/images/btn_setting.png" alt="" /></a>
            </div>
            <div class="battery__contents">
                <div class="battery__progress" data-percent="80">
                    <div class="battery__bar"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="contents">
        <div class="button-list">
            <ul>
                <li><a href="/admindashboard/" class="back"><img src="/assets/images/icon_back.png" alt="" />뒤로가기</a></li>
            </ul>
        </div>

        <div class="setting">
			 
			<div class="sensor">
				<div class="sensor__head">
					<h4 class="sensor__title">연기센서</h4>
					<button class="sensor__add">추가</button>
				</div>
				<div class="sensor__body">
                    <ul id="smokeUl">
                    </ul>
				</div>
			</div>
			
			<div class="sensor">
				<div class="sensor__head">
					<h4 class="sensor__title">가스센서</h4>
					<button class="sensor__add">추가</button>
				</div>
				<div class="sensor__body">
					<ul id="gasUl">
					</ul>
				</div>
			</div>
			
			<div class="sensor">
				<div class="sensor__head">
					<h4 class="sensor__title">멀티센서</h4>
					<button class="sensor__add">추가</button>
				</div>
				<div class="sensor__body">
					<ul id="motionUl">
					</ul>
				</div>
			</div>

			<button onclick="detectPut()" class="setting__btn">저장</button>

        </div>
    </div>
</div>
</body>
</html>
